# 微信小程序登录接口文档

## 概述

本文档描述了微信小程序登录相关的接口实现，主要用于通过 `code` 换取用户 `openid` 和 `session_key`。

## 核心组件

### 1. WxService - 核心服务类
- **位置**: `src/main/java/weixin/order_food/service/WxService.java`
- **功能**: 实现微信 `code2Session` 接口调用
- **主要方法**:
  - `codeToSession(String code)`: 获取完整会话信息
  - `getOpenId(String code)`: 仅获取用户 openid
  - `getSessionKey(String code)`: 仅获取 session key

### 2. 配置类
- **WechatConfig**: 微信小程序配置（appId、appSecret）
- **RestTemplateConfig**: HTTP 客户端配置

### 3. 数据传输对象
- **WechatSessionResponse**: 微信接口响应结果封装

### 4. 异常处理
- **WechatException**: 自定义微信业务异常

## 接口说明

### POST /api/wechat/login
**完整登录接口**

#### 请求参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| code | string | 是 | 小程序登录凭证 |

#### 响应示例
```json
{
  "success": true,
  "openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M",
  "sessionKey": "JmNerW/VIK6+RmtiUQCkGQ=="
}
```

#### 错误响应
```json
{
  "success": false,
  "errorCode": 40029,
  "message": "微信接口返回错误，错误码：40029，错误信息：invalid code"
}
```

### GET /api/wechat/openid
**简化接口 - 仅获取 openid**

#### 请求参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| code | string | 是 | 小程序登录凭证 |

#### 响应示例
```json
{
  "success": true,
  "openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M"
}
```

## 配置说明

在 `application.yaml` 中配置微信小程序信息：

```yaml
wechat:
  miniapp:
    app-id: your-app-id-here        # 替换为实际的 appId
    app-secret: your-app-secret-here # 替换为实际的 appSecret
```

## 使用示例

### 后端调用示例
```java
@Autowired
private WxService wxService;

// 方式一：获取完整信息
WechatSessionResponse response = wxService.codeToSession(code);
String openid = response.getOpenid();
String sessionKey = response.getSessionKey();

// 方式二：仅获取 openid
String openid = wxService.getOpenId(code);
```

### 小程序端调用示例
```javascript
// 小程序登录
wx.login({
  success: function(res) {
    if (res.code) {
      // 发送 code 到后端
      wx.request({
        url: 'http://localhost:8080/api/wechat/login',
        method: 'POST',
        data: {
          code: res.code
        },
        success: function(response) {
          console.log('登录成功', response.data);
          // 保存 openid 和其他信息
        }
      });
    }
  }
});
```

## 错误码说明

常见的微信接口错误码：
- `40013`: invalid appid
- `40125`: invalid appsecret
- `40029`: invalid code
- `45011`: API 调用太频繁

## 注意事项

1. **安全性**: appSecret 属于敏感信息，请妥善保管，不要泄露
2. **频率限制**: 微信对接口调用有频率限制，请合理控制调用次数
3. **HTTPS**: 生产环境建议使用 HTTPS
4. **日志**: 敏感信息（如 session_key）不应记录到日志中

## 扩展建议

1. 可以在此基础上实现 JWT token 生成
2. 添加用户信息存储和管理
3. 实现 session key 的缓存机制
4. 添加更详细的业务逻辑处理